'use strict';
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    }
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var GUID_1 = require("./GUID");
var AsfObject = require("./AsfObject");
var _debug = require("debug");
var BasicParser_1 = require("../common/BasicParser");
var debug = _debug("music-metadata:parser:ASF");
var headerType = 'asf';
/**
 * Windows Media Metadata Usage Guidelines
 *   Ref: https://msdn.microsoft.com/en-us/library/ms867702.aspx
 *
 * Ref:
 *   https://tools.ietf.org/html/draft-fleischman-asf-01
 *   https://hwiegman.home.xs4all.nl/fileformats/asf/ASF_Specification.pdf
 *   http://drang.s4.xrea.com/program/tips/id3tag/wmp/index.html
 *   https://msdn.microsoft.com/en-us/library/windows/desktop/ee663575(v=vs.85).aspx
 */
var AsfParser = /** @class */ (function (_super) {
    __extends(AsfParser, _super);
    function AsfParser() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    AsfParser.prototype.parse = function () {
        var _this = this;
        return this.tokenizer.readToken(AsfObject.TopLevelHeaderObjectToken).then(function (header) {
            if (!header.objectId.equals(GUID_1.default.HeaderObject)) {
                throw new Error('expected asf header; but was not found; got: ' + header.objectId.str);
            }
            return _this.parseObjectHeader(header.numberOfHeaderObjects).catch(function (err) {
                debug("Error while parsing ASF: %s", err);
            });
        });
    };
    AsfParser.prototype.parseObjectHeader = function (numberOfObjectHeaders) {
        var _this = this;
        // Parse common header of the ASF Object (3.1)
        return this.tokenizer.readToken(AsfObject.HeaderObjectToken).then(function (header) {
            // Parse data part of the ASF Object
            debug("header GUID=%s", header.objectId.str);
            switch (header.objectId.str) {
                case AsfObject.FilePropertiesObject.guid.str: // 3.2
                    return _this.tokenizer.readToken(new AsfObject.FilePropertiesObject(header)).then(function (fpo) {
                        _this.metadata.setFormat('duration', fpo.playDuration / 10000000);
                        _this.metadata.setFormat('bitrate', fpo.maximumBitrate);
                    });
                case AsfObject.StreamPropertiesObject.guid.str: // 3.3
                    return _this.tokenizer.readToken(new AsfObject.StreamPropertiesObject(header)).then(function (spo) {
                        _this.metadata.setFormat('dataformat', 'ASF/' + spo.streamType);
                    });
                case AsfObject.HeaderExtensionObject.guid.str: // 3.4
                    return _this.tokenizer.readToken(new AsfObject.HeaderExtensionObject()).then(function (extHeader) {
                        return _this.parseExtensionObject(extHeader.extensionDataSize);
                    });
                case AsfObject.ContentDescriptionObjectState.guid.str: // 3.10
                    return _this.tokenizer.readToken(new AsfObject.ContentDescriptionObjectState(header)).then(function (tags) {
                        _this.addTags(tags);
                    });
                case AsfObject.ExtendedContentDescriptionObjectState.guid.str: // 3.11
                    return _this.tokenizer.readToken(new AsfObject.ExtendedContentDescriptionObjectState(header)).then(function (tags) {
                        _this.addTags(tags);
                        return header.objectSize;
                    });
                case GUID_1.default.CodecListObject.str:
                    // ToDo?
                    return _this.tokenizer.ignore(header.objectSize - AsfObject.HeaderObjectToken.len);
                case GUID_1.default.StreamBitratePropertiesObject.str:
                    // ToDo?
                    return _this.tokenizer.ignore(header.objectSize - AsfObject.HeaderObjectToken.len);
                case GUID_1.default.PaddingObject.str:
                    // ToDo: register bytes pad
                    debug("Padding: %s bytes", header.objectSize - AsfObject.HeaderObjectToken.len);
                    return _this.tokenizer.ignore(header.objectSize - AsfObject.HeaderObjectToken.len);
                default:
                    _this.warnings.push("Ignore ASF-Object-GUID: " + header.objectId.str);
                    debug("Ignore ASF-Object-GUID: %s", header.objectId.str);
                    return _this.tokenizer.readToken(new AsfObject.IgnoreObjectState(header));
            }
        }).then(function () {
            --numberOfObjectHeaders;
            if (numberOfObjectHeaders > 0) {
                return _this.parseObjectHeader(numberOfObjectHeaders);
            }
            // done
        });
    };
    AsfParser.prototype.addTags = function (tags) {
        var _this = this;
        tags.forEach(function (tag) {
            _this.metadata.addTag(headerType, tag.id, tag.value);
        });
    };
    AsfParser.prototype.parseExtensionObject = function (extensionSize) {
        var _this = this;
        // Parse common header of the ASF Object (3.1)
        return this.tokenizer.readToken(AsfObject.HeaderObjectToken).then(function (header) {
            // Parse data part of the ASF Object
            switch (header.objectId.str) {
                case AsfObject.ExtendedStreamPropertiesObjectState.guid.str: // 4.1
                    return _this.tokenizer.readToken(new AsfObject.ExtendedStreamPropertiesObjectState(header)).then(function (cd) {
                        return header.objectSize;
                    });
                case AsfObject.MetadataObjectState.guid.str: // 4.7
                    return _this.tokenizer.readToken(new AsfObject.MetadataObjectState(header)).then(function (tags) {
                        _this.addTags(tags);
                        return header.objectSize;
                    });
                case AsfObject.MetadataLibraryObjectState.guid.str: // 4.8
                    return _this.tokenizer.readToken(new AsfObject.MetadataLibraryObjectState(header)).then(function (tags) {
                        _this.addTags(tags);
                        return header.objectSize;
                    });
                case GUID_1.default.PaddingObject.str:
                    // ToDo: register bytes pad
                    return _this.tokenizer.ignore(header.objectSize - AsfObject.HeaderObjectToken.len).then(function () { return header.objectSize; });
                case GUID_1.default.CompatibilityObject.str:
                    return _this.tokenizer.ignore(header.objectSize - AsfObject.HeaderObjectToken.len).then(function () { return header.objectSize; });
                case GUID_1.default.ASF_Index_Placeholder_Object.str:
                    return _this.tokenizer.ignore(header.objectSize - AsfObject.HeaderObjectToken.len).then(function () { return header.objectSize; });
                default:
                    _this.warnings.push("Ignore ASF-Object-GUID: " + header.objectId.str);
                    // console.log("Ignore ASF-Object-GUID: %s", header.objectId.str);
                    return _this.tokenizer.readToken(new AsfObject.IgnoreObjectState(header));
            }
        }).then(function (objectSize) {
            extensionSize -= objectSize;
            if (extensionSize > 0) {
                return _this.parseExtensionObject(extensionSize);
            }
            else {
                // done
                return 0;
            }
        });
    };
    return AsfParser;
}(BasicParser_1.BasicParser));
exports.AsfParser = AsfParser;
